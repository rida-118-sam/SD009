<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Infinite Feed</title>
    <style>
        body { font-family: Arial; background: #f0f0f0; }
        .tab-buttons { text-align: center; margin: 10px; }
        .tab-buttons button {
            padding: 10px; margin: 5px; font-weight: bold;
            border: none; border-radius: 5px; background: #ddd;
            cursor: pointer;
        }
        .feed-container {
            max-width: 700px; margin: auto; padding: 20px;
        }
        .post {
            background: #fff; padding: 15px; margin-bottom: 15px;
            border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .post:hover { background: #f9f9f9; }
        iframe, img {
            width: 100%; max-height: 400px; margin-top: 10px;
            border-radius: 10px;
        }
    </style>
</head>
<body>

<h2 style="text-align:center;">Infinite Feed</h2>

<div class="tab-buttons">
    <button onclick="switchCategory('photo')">Photo</button>
    <button onclick="switchCategory('video')">Video</button>
    <button onclick="switchCategory('reel')">Reel</button>
</div>

<div class="feed-container" id="feed"></div>

<script>
    let currentCategory = 'photo';
    let page = 1;
    let loading = false;

    function extractYouTubeID(url) {
        const match = url.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)([^?&"'>]+)/);
        return match ? match[1] : null;
    }

    function loadPosts() {
        if (loading) return;
        loading = true;

        fetch(`/get_posts/${currentCategory}?page=${page}`)
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) {
                    // Reached end, reset to page 1 and continue
                    page = 1;
                    loading = false;
                    setTimeout(loadPosts, 300); // loop silently
                    return;
                }

                const container = document.getElementById("feed");

                data.forEach(post => {
                    const div = document.createElement("div");
                    div.className = "post";

                    div.innerHTML = `
                        <h3>${post.title}</h3>
                        <p>${post.description}</p>
                    `;

                    if (post.type === 'photo') {
                        div.innerHTML += `<img src="${post.url}" alt="Photo">`;
                    } else if (post.type === 'video' || post.type === 'reel') {
                        div.innerHTML += `<iframe src="${post.url}" frameborder="0" allowfullscreen></iframe>`;
                    }

                    container.appendChild(div);
                });

                page++;
                loading = false;
            })
            .catch(() => { loading = false; });
    }

    function switchCategory(category) {
        currentCategory = category;
        page = 1;
        document.getElementById("feed").innerHTML = "";
        loadPosts();
    }

    window.addEventListener("scroll", () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
            loadPosts();
        }
    });

    loadPosts(); // Initial load
</script>

</body>
</html>